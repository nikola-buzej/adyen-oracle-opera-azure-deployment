{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.22.6.54827",
      "templateHash": "5905309055418297766"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location where the resources will be created."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. The tags to be assigned to the created resources."
      }
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "defaultValue": "container-apps-env-test",
      "metadata": {
        "description": "Optional. The name of the container apps environment. If set, it overrides the name generated by the template."
      }
    },
    "serverName": {
      "type": "string",
      "defaultValue": "database-server",
      "metadata": {
        "description": "The name of the database server"
      }
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "log-analytics-workspace-test",
      "metadata": {
        "description": "Optional. The name of the log analytics workspace. If set, it overrides the name generated by the template."
      }
    },
    "applicationInsightName": {
      "type": "string",
      "defaultValue": "application-insight-name",
      "metadata": {
        "description": "Optional. The name of the application insights. If set, it overrides the name generated by the template."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for db"
      }
    },
    "backendApiServiceImage": {
      "type": "string",
      "metadata": {
        "description": "The docker image"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "containerAppsEnv-Test",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "containerAppsEvnironmentName": {
            "value": "[parameters('containerAppsEnvironmentName')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "applicationInsightName": {
            "value": "[parameters('applicationInsightName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.22.6.54827",
              "templateHash": "138779919574169695"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the resources"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to be assigned"
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the log analytics workspace. If set, it overrides the name generated by the template."
              }
            },
            "containerAppsEvnironmentName": {
              "type": "string",
              "metadata": {
                "description": "The name of the container apps environment"
              }
            },
            "applicationInsightName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "features": {
                  "searchVersion": 1
                },
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2022-10-01",
              "name": "[parameters('containerAppsEvnironmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "applicationInsightName": {
              "type": "string",
              "metadata": {
                "description": "The name of the application insights"
              },
              "value": "[parameters('applicationInsightName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "postgres-cosmos-test",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "administratorLoginPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "serverName": {
            "value": "[parameters('serverName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.22.6.54827",
              "templateHash": "10108978533947110151"
            }
          },
          "parameters": {
            "administratorLoginPassword": {
              "type": "securestring"
            },
            "location": {
              "type": "string"
            },
            "serverName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('serverName'), 'test')]",
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2021-06-01",
              "name": "[parameters('serverName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_B1ms",
                "tier": "Burstable"
              },
              "properties": {
                "administratorLogin": "adyen",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "createMode": "Create",
                "version": "14",
                "storage": {
                  "storageSizeGB": 32
                }
              }
            }
          ],
          "outputs": {
            "dbServerId": {
              "type": "string",
              "metadata": {
                "description": "Id of the postgres database server"
              },
              "value": "[format('Host={0};Database=test;Username=adyen;Password={1}', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('serverName')), '2021-06-01').fullyQualifiedDomainName, parameters('administratorLoginPassword'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "container-apps-test",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "backendApiServiceImage": {
            "value": "[parameters('backendApiServiceImage')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "dbName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'postgres-cosmos-test'), '2022-09-01').outputs.dbServerId.value]"
          },
          "containerAppsEnvironmentName": {
            "value": "[parameters('containerAppsEnvironmentName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.22.6.54827",
              "templateHash": "17929281951619561023"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location where the resources will be created."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "containerAppsEnvironmentName": {
              "type": "string",
              "metadata": {
                "description": "The name of the container apps environment."
              }
            },
            "dbName": {
              "type": "string",
              "metadata": {
                "description": "the db"
              }
            },
            "backendApiServiceImage": {
              "type": "string",
              "metadata": {
                "description": "The image for the backend api service."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "backend-api-service-test",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "backendApiServiceImage": {
                    "value": "[parameters('backendApiServiceImage')]"
                  },
                  "containerAppsEnvironmentId": {
                    "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName'))]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "dbName": {
                    "value": "[parameters('dbName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.22.6.54827",
                      "templateHash": "10092970993873173113"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The location where the resources will be created."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. The tags to be assigned to the created resources."
                      }
                    },
                    "containerAppsEnvironmentId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource Id of the container apps environment."
                      }
                    },
                    "backendApiServiceImage": {
                      "type": "string",
                      "metadata": {
                        "description": "The image for the backend api service."
                      }
                    },
                    "dbName": {
                      "type": "string",
                      "metadata": {
                        "description": "The db name."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/containerApps",
                      "apiVersion": "2023-05-01",
                      "name": "backend-api-service",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "managedEnvironmentId": "[parameters('containerAppsEnvironmentId')]",
                        "configuration": {
                          "activeRevisionsMode": "Single",
                          "ingress": {
                            "external": true,
                            "targetPort": 8080
                          },
                          "secrets": [
                            {
                              "name": "connection-string",
                              "value": "[parameters('dbName')]"
                            }
                          ]
                        },
                        "template": {
                          "containers": [
                            {
                              "name": "backend-service-api",
                              "image": "[parameters('backendApiServiceImage')]",
                              "resources": {
                                "cpu": "[json('0.25')]",
                                "memory": "0.5Gi"
                              },
                              "env": [
                                {
                                  "name": "Logging__LogLevel__Default",
                                  "value": "Information"
                                },
                                {
                                  "name": "Logging__LogLevel__Microsoft.AspNetCore",
                                  "value": "Warning"
                                },
                                {
                                  "name": "ConnectionStrings__Database",
                                  "value": "[parameters('dbName')]"
                                }
                              ]
                            }
                          ],
                          "scale": {
                            "minReplicas": 1,
                            "maxReplicas": 1
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'containerAppsEnv-Test')]",
        "[resourceId('Microsoft.Resources/deployments', 'postgres-cosmos-test')]"
      ]
    }
  ]
}